# CP2K 2025 編譯與安裝

在 openSUSE 16 系統上，使用 Intel oneAPI 工具鏈編譯高效能的量子化學與固態物理軟體 [CP2K](https://www.cp2k.org/)。CP2K 能夠執行多種原子和分子模擬，其效能高度依賴於編譯時的優化設定。

## 1. 安裝步驟

## 1-1. 環境設定

編譯 CP2K 前，需要先載入 Intel oneAPI 的環境。以提供最新的 Intel C++ (`icpx`) 和 Fortran (`ifx`) 編譯器，以及數學核心函式庫 (MKL)。

- **`source /opt/intel/oneapi/setvars.sh`**: 此指令會設定必要的環境變數，讓系統能夠找到 Intel 的編譯工具。

  ```bash
  tux@suse16:~> source /opt/intel/oneapi/setvars.sh
  :: initializing oneAPI environment ...
     -bash: BASH_VERSION = 5.2.26(1)-release
     :: oneAPI environment initialized ::
  ```

## 1-2. 取得與解壓縮原始碼

首先，下載 CP2K 的原始碼壓縮檔 `cp2k-2025.2.tar.bz2`，然後進行解壓縮。

- **`tar jxf`**: 這個指令用於解壓縮 `.tar.bz2` 格式的檔案。`j` 代表使用 `bzip2` 解壓，`x` 是解壓縮，`f` 指示操作對象為檔案。

  ```bash
  tux@suse16:~> tar jxf cp2k-2025.2.tar.bz2
  tux@suse16:~> cd cp2k-2025.2/
  ```

  解壓縮完成後，進入 `cp2k-2025.2` 目錄，準備開始編譯。

## 1-3. 編譯 CP2K

CP2K 的編譯系統非常靈活，允許使用者透過 `make` 指令傳遞多個參數來客製化編譯過程。

- **`make ...`**: 這是本次編譯的核心指令，各參數意義如下：

  - `CXX=icpx`: 指定使用 Intel oneAPI 的 C++ 編譯器 `icpx`。
  - `ARCH=Linux-x86-64-intel`: 指定目標架構設定檔。CP2K 在 `arch/` 目錄下提供了多種預設設定，此處選擇 `Linux-x86-64-intel`，代表在 64 位元 Linux 系統上使用 Intel 編譯器。
  - `VERSION=psmp`: 指定要編譯的版本。`psmp` 是混合並行版本，同時使用 MPI (Message Passing Interface) 進行跨節點通訊和 OpenMP 進行節點內多執行緒計算，能有效利用現代多核心處理器架構。
  - `WITH_IFX=yes`: 明確啟用 Intel 最新的 LLVM-based Fortran 編譯器 `ifx`。這對於需要 Fortran 編譯的部分至關重要。
  - `cp2k`: 指定 `make` 的最終目標，即生成名為 `cp2k` 的主程式。

  ```bash
  tux@suse16:~/cp2k-2025.2> make CXX=icpx ARCH=Linux-x86-64-intel VERSION=psmp WITH_IFX=yes cp2k
  ... (大量的編譯訊息) ...
  ```

## 1-4. 檢查執行檔

編譯完成後，執行檔會被放置在 `exe/` 目錄下對應 `ARCH` 名稱的子目錄中。

- **`ls exe/Linux-x86-64-intel/`**: 使用此指令可以查看生成的可執行檔案。

  ```bash
  tux@suse16:~/cp2k-2025.2> ls exe/Linux-x86-64-intel/
  cp2k.psmp
  ```

  可以看到，編譯成功的檔案為 `cp2k.psmp`。`.psmp` 的後綴名對應了在 `VERSION` 參數中指定的版本。若要執行，通常會建立一個符號連結 (symbolic link) `cp2k` 指向這個檔案，或直接執行 `cp2k.psmp`。

---

## 練習

1.  **探索架構檔**：進入 `cp2k-2025.2/arch/` 目錄，找到 `Linux-x86-64-intel.psmp` 這個檔案。打開它，看看裡面定義了哪些編譯器旗標 (Compiler Flags)，例如 `CFLAGS`、`FCFLAGS` 等。
2.  **編譯不同版本**：CP2K 也支援 `sopt` (單執行緒優化) 和 `popt` (純 MPI 並行) 版本。請試著修改 `make` 指令中的 `VERSION` 參數，編譯出 `cp2k.sopt`。
3.  **尋找工具鏈**：在 `cp2k-2025.2/tools/toolchain/` 目錄下，可找到 CP2K 用來自動下載並安裝所需函式庫 (如 ELPA, ScaLAPACK) 的腳本。請嘗試執行 `install_cp2k_toolchain.sh` 腳本，了解它會安裝哪些依賴套件。

---

## 總結

介紹在 openSUSE 系統上使用 Intel oneAPI 編譯器編譯 CP2K 的完整流程。從環境設定、解壓縮原始碼，到執行客製化的 `make` 指令，每一步都至關重要。選擇正確的 `ARCH` 和 `VERSION` 參數，是發揮 CP2K 在特定硬體上最佳效能的關鍵。透過 `psmp` 版本的編譯，可獲得一個能夠充分利用多節點、多核心叢集資源的高效能執行檔。
