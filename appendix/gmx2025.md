# GROMACS 2025 安裝編譯與安裝筆記

介紹如何在 openSUSE 16 系統上，從原始碼編譯並安裝 GROMACS 2025。GROMACS 是一款功能強大且廣泛使用的分子動力學 (Molecular Dynamics, MD) 模擬軟體套件，專為研究蛋白質、脂質和核酸等生物化學分子的物理運動而設計。

GROMACS 以其卓越的計算速度和高效的平行處理能力而聞名，能夠充分利用現代 CPU 與 GPU 的運算資源。這使其不僅適用於生物分子系統，也常用於非生物系統（如高分子材料）的研究。

## 1. 安裝步驟

以下步驟將引導您完成 GROMACS 的完整安裝流程，包含前置套件準備、環境設定、編譯與安裝。

### 1-1. 安裝編譯所需的基礎套件

在開始編譯 GROMACS 之前，需要先安裝必要的開發工具與函式庫。

- **`zypper in -t pattern devel_basis`**: 此指令用於安裝 `devel_basis` 模式 (pattern)，它包含了在 openSUSE 上進行軟體開發所需的一整套基礎工具，例如 `gcc` 編譯器、`make` 工具以及其他核心函式庫與標頭檔。
- **`zypper install cmake-full`**: GROMACS 使用 `CMake` 作為其跨平台的建構系統，來產生適用於本機環境的 `Makefile`。`cmake-full` 包含了完整的 CMake 功能。

```bash
server:~ # zypper in -t pattern devel_basis
server:~ # zypper install cmake-full
```

### 1-2. 設定 Intel oneAPI 環境 (可選)

為了獲得最佳效能，GROMACS 可以利用 Intel 的 MKL (Math Kernel Library) 函式庫來處理傅立葉轉換 (FFT)。若系統已安裝 Intel oneAPI，請執行以下指令來設定環境變數，讓編譯系統能找到 MKL。

- **`source /opt/intel/oneapi/setvars.sh`**: 此指令會執行 Intel 提供的腳本，設定 `PATH`, `LD_LIBRARY_PATH` 等環境變數。

```bash
# intel env
server:~ > source /opt/intel/oneapi/setvars.sh
```

### 1-3. 下載、解壓縮與編譯 GROMACS

接下來，將下載 GROMACS 的原始碼並進行編譯。

1.  **下載與解壓縮**:

    - **`tar zxf gromacs-2025.3.tar.gz`**: 將 GROMACS 的原始碼壓縮包解壓縮。
    - **`cd gromacs-2025.3`**: 進入解壓縮後的原始碼目錄。

    ```bash
    server:~ > tar zxf gromacs-2025.3.tar.gz
    server:~ > cd gromacs-2025.3
    ```

2.  **建立獨立的建構目錄**:
    在原始碼目錄外建立一個獨立的 `build` 目錄是一個好習慣，這可以避免污染原始碼，並方便日後清理。

    - **`mkdir build && cd build`**: 建立並進入 `build` 目錄。

    ```bash
    # build
    server:~/gromacs-2025.3 > mkdir build
    server:~/gromacs-2025.3 > cd build
    ```

3.  **使用 CMake 設定建構選項**:
    這是整個編譯過程中最關鍵的一步。`cmake` 指令後方的參數定義了 GROMACS 將如何被編譯。

    ```bash
    server:~/gromacs-2025.3/build > cmake -DGMX_FFT_LIBRARY=mkl -DGMX_SIMD=AVX2_256 -DGMX_MPI=ON -DGMX_OPENMP=ON -DBUILD_SHARED_LIBS=ON -DGMX_DOUBLE=OFF -DGMX_GPU=OFF -DGMX_HWLOC=OFF -DCMAKE_C_COMPILER=mpiicx -DCMAKE_CXX_COMPILER=mpiicpx -DCMAKE_BUILD_TYPE=Release -DCMAKE_COLOR_MAKEFILE=ON -DCMAKE_VERBOSE_MAKEFILE=TRUE -DCMAKE_INSTALL_PREFIX=$HOME/gromacs ..
    ```

    **參數詳解**:

    - `-DGMX_FFT_LIBRARY=mkl`: 指定使用 Intel MKL 作為 FFT 函式庫。
    - `-DGMX_SIMD=AVX2_256`: 指定使用 AVX2_256 指令集進行 SIMD (單指令多資料流) 優化，以加速計算。
    - `-DGMX_MPI=ON`: 啟用 MPI (Message Passing Interface) 支援，用於跨節點的平行計算。
    - `-DGMX_OPENMP=ON`: 啟用 OpenMP 支援，用於單一節點內的多核心平行計算。
    - `-DBUILD_SHARED_LIBS=ON`: 將 GROMACS 函式庫編譯為共享函式庫 (.so)。
    - `-DGMX_DOUBLE=OFF`: 使用單精度 (single precision) 進行計算。對於大部分模擬，單精度已足夠且速度更快。
    - `-DGMX_GPU=OFF`: 關閉 GPU 加速。若要使用 NVIDIA GPU，可設為 `CUDA` 或 `OpenCL`。
    - `-DGMX_HWLOC=OFF`: 關閉硬體拓撲偵測。
    - `-DCMAKE_C_COMPILER=mpiicx`: 指定使用 Intel 的 MPI C 編譯器。
    - `-DCMAKE_CXX_COMPILER=mpiicpx`: 指定使用 Intel 的 MPI C++ 編譯器。
    - `-DCMAKE_BUILD_TYPE=Release`: 指定為「發行版」建構，會開啟編譯器優化。
    - `-DCMAKE_INSTALL_PREFIX=$HOME/gromacs`: 指定安裝路徑為使用者家目錄下的 `gromacs` 資料夾。
    - `..`: 指向上層目錄，即 GROMACS 原始碼的根目錄。

4.  **編譯、測試與安裝**:

    - **`make`**: 根據 `Makefile` 開始編譯程式。
    - **`make check`**: (建議執行) 執行內建的測試程式，以確保編譯出的程式功能正常。
    - **`make install`**: 將編譯好的執行檔、函式庫與說明文件複製到 `-DCMAKE_INSTALL_PREFIX` 指定的路徑。

    ```bash
    server:~/gromacs-2025.3/build > make
    server:~/gromacs-2025.3/build > make check
    server:~/gromacs-2025.3/build > make install
    ```

### 1-4. 設定 GROMACS 環境

為了讓系統能隨時找到 GROMACS 的執行檔，需要將其安裝路徑加入環境變數中。

- **`source $HOME/gromacs/bin/GMXRC`**: GROMACS 提供了一個方便的腳本 `GMXRC`，執行它即可自動設定好所有必要的環境變數。建議將此行加入 `~/.bashrc` 或 `~/.zshrc` 檔案中，以便每次登入時自動載入。

```bash
server:~ > source $HOME/gromacs/bin/GMXRC
```

## 練習

1.  **檢查安裝**: 重新登入或執行 `source $HOME/gromacs/bin/GMXRC` 後，在終端機輸入 `gmx -h`。如果安裝成功，應該會顯示 GROMACS 的說明訊息。
2.  **修改編譯選項**: 嘗試在 `cmake` 步驟中，將 `-DGMX_DOUBLE=OFF` 改為 `-DGMX_DOUBLE=ON`，重新編譯並安裝，體會雙精度版本與單精度版本的差異。 (提示: 需要先刪除 `build` 目錄下的 `CMakeCache.txt` 檔案再重新執行 `cmake`)

## 總結

從頭完成 GROMACS 的編譯與安裝。這過程熟悉了在 Linux 環境下從原始碼建構複雜科學計算軟體的標準流程：`configure (cmake)` -> `make` -> `make install`。理解 `cmake` 中的各項參數，是未來根據不同硬體 (如 AMD CPU 或 NVIDIA GPU) 或計算需求（如 MPI 平行）進行客製化編譯的關鍵。
