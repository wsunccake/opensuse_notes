# Gaussian 16 編譯與安裝

將如何在 openSUSE 系統上，使用 NVIDIA HPC SDK 編譯器來編譯量子化學計算軟體 Gaussian 16。

## 1. 前置準備：安裝依賴套件

編譯前，需安裝開發工具及 Gaussian 腳本所需的 `tcsh`。

- **`devel_basis`**: 安裝 C/C++ 與 Fortran 編譯器、`make` 等基礎開發工具。
- **`tcsh`**: Gaussian 的部分腳本是使用 C Shell (csh) 或其延伸版本 `tcsh` 編寫的，因此必須安裝。

```bash
# 以 root 權限安裝基礎開發工具
tux@suse16:~ > sudo zypper in -t pattern devel_basis
# 安裝 tcsh
tux@suse16:~ > sudo zypper in tcsh
```

## 2. 編譯 Gaussian 16

### 2.1. 設定 NVIDIA HPC SDK 編譯環境

使用 NVIDIA HPC SDK (前身為 PGI) 進行編譯，提供了針對科學計算優化的高效能編譯器。

- **`export` 指令**: 這些指令用於設定環境變數，讓系統能夠找到 NVIDIA HPC SDK 的編譯器 (`pgf77`, `pgcc`)、函式庫和說明文件。

```bash
# 設定系統架構變數，例如 Linux_x86_64
tux@suse16:~ > export NVARCH=`uname -s`_`uname -m`
# 設定 NVIDIA HPC SDK 的安裝路徑
tux@suse16:~ > export NVCOMPILERS=/opt/nvidia/hpc_sdk
# 將 SDK 的 man page 加入 MANPATH
tux@suse16:~ > export MANPATH=$MANPATH:$NVCOMPILERS/$NVARCH/25.7/compilers/man
# 將 SDK 的執行檔目錄加入 PATH，確保優先使用
tux@suse16:~ > export PATH=$NVCOMPILERS/$NVARCH/25.7/compilers/bin:$PATH
```

- **查詢處理器優化選項**:

  - **`pgf77 -help -tp`**: 此指令會列出編譯器支援的目標處理器 (`-tp`) 選項。選擇符合您 CPU 的微架構級別，可以讓編譯器產生更高效的機器碼。例如 `x86-64-v3` 適用於支援 AVX2 指令集的現代 CPU。

  ```bash
  # 查詢支援的目標處理器
  tux@suse16:~ > pgf77 -help -tp
  ```

### 2.2. 解壓縮與設定 Gaussian 環境

```bash
# 解壓縮原始碼 (j 表示 bzip2 格式)
tux@suse16:~ > tar jxf wkssrc.tbz

# 設定 Gaussian 的根目錄
tux@suse16:~ > export g16root=$HOME
# 進入原始碼目錄
tux@suse16:~ > cd g16
# 載入 Gaussian 的環境設定檔
tux@suse16:~/g16 > source bsd/g16.profile
```

### 2.3. 修改編譯設定檔

為了讓 Gaussian 使用正確的編譯器選項和目標架構，需要修改幾個設定檔。

#### `bsd/i386.make` 修改

這個檔案定義了 C 編譯器和目標機器類型。

- **`RUNCC = cc -g -std=gnu17`**: 為 C 編譯器加上 `-std=gnu17` 旗標，(gcc-15 預設是 `-std=gnu23`)。
- **`MACHTY = x86-64-v3`**: 將目標機器類型從預設的 `p7-64` (通用 x86 Intel Pentium 64-bit 處理器架構，此版以不支援該選項) 修改為 `x86-64-v3`，以針對現代 x86 CPU 進行優化。

```diff
# bsd/i386.make
- RUNCC = cc -g
...
- MACHTY = p7-64
+ RUNCC = cc -g -std=gnu17
...
+ MACHTY = x86-64-v3
```

#### 使用 `sed` 修改其他設定檔

目標架構的設定散落在多個檔案中，使用 `sed` 指令可以快速完成替換。

```bash
# 將 bsd/set-mflags 中的 p7-64 替換為 x86-64-v3
tux@suse16:~/g16 > sed -i s/p7-64/x86-64-v3/ bsd/set-mflags
# 將 bsd/setup-make 中的 p7-64 替換為 x86-64-v3
tux@suse16:~/g16 > sed -i s/p7-64/x86-64-v3/ bsd/setup-make
```

### 2.4. 執行編譯

完成所有設定後，執行 Gaussian 的主編譯腳本。

```bash
# 進入 g16 目錄
tux@suse16:~ > cd g16
# 執行編譯腳本
tux@suse16:~/g16 > ./bsd/bldg16
```

這個過程會需要一些時間，它會自動編譯所有必要的模組。

---

## 練習

1.  **查詢 CPU 支援的指令集**：執行 `cat /proc/cpuinfo | grep flags`，查看您的 CPU 是否支援 `avx2` 和 `fma`。如果支援，`x86-64-v3` 就是一個合適的選擇。
2.  **手動修改**：不使用 `sed`，請手動開啟 `bsd/set-mflags` 和 `bsd/setup-make` 檔案，找到並替換 `p7-64` 字串。
3.  **檢查環境變數**：執行 `env | grep g16`，查看 `source bsd/g16.profile` 後，設定了哪些與 Gaussian 相關的環境變數。

## 總結

學習如何編譯 Gaussian 16，重點如下：

1.  **環境設定**：除了安裝 `devel_basis` 和 `tcsh`，最關鍵的是正確設定 NVIDIA HPC SDK 的環境變數，讓系統使用 `pgf77` 等高效能編譯器。
2.  **目標架構優化**：透過 `-tp` 選項並修改 `MACHTY` 等變數，將編譯目標從預設值改為符合現代 CPU 的 `x86-64-v3`，這是獲取高效能執行檔的關鍵。
3.  **腳本化編譯**：Gaussian 的編譯過程由其內建的 `bldg16` 腳本驅動，我們的工作是為這個腳本準備好正確的環境與設定。
