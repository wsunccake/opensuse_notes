# ch3. Linux 系統管理 (System Management)

將介紹在 Linux 系統中用於系統管理與監控的常用指令，內容涵蓋行程、硬體、系統監控、效能分析以及網路問題排查。

## 3-1. 行程管理 (Process Management)

行程是程式執行的實例。透過行程管理指令，我們可以查看、控制和調整系統中執行的程式。

- **`ps`**: 顯示當前行程的狀態 (Process Status)。這是一個非常基本且功能強大的指令，用於查看系統上有哪些正在執行的行程。

  - **顯示所有使用者的行程 (BSD 風格) (`aux`)**:
    ```bash
    tux@suse16:~> ps aux
    ```
  - **顯示所有行程的完整資訊 (System V 風格) (`-ef`)**:
    ```bash
    tux@suse16:~> ps -ef
    ```
  - **以樹狀結構檢視 (`--forest`)**
    ```bash
    tux@suse16:~> ps --forest
    ```

- **`pstree`**: 以樹狀圖顯示行程間的父子關係。這有助於理解行程的啟動來源。

  - **顯示每個行程的 PID (`-p`)**:
    ```bash
    tux@suse16:~> pstree -p
    ```
  - **顯示每個行程的完整指令 (`-a`)**:
    ```bash
    tux@suse16:~> pstree -a
    ```

- **`pgrep`**: 根據名稱或其他屬性來尋找行程的 PID。

  - **尋找名稱包含 "sshd" 的行程 PID**:
    ```bash
    tux@suse16:~> pgrep sshd
    ```
  - **尋找屬於 "tux" 使用者的所有行程，並列出行程名稱與 PID**:
    ```bash
    tux@suse16:~> pgrep -l -u tux
    ```

- **`kill`**: 傳送訊號 (signal) 給指定的行程，通常用於終止行程。

  - **正常地終止一個行程 (傳送 SIGTERM 訊號)**:
    ```bash
    tux@suse16:~> kill 1234
    ```
  - **強制終止一個行程 (傳送 SIGKILL 訊號，行程無法忽略)**:
    ```bash
    tux@suse16:~> kill -9 1234
    ```

- **`killall`**: 根據行程名稱來終止所有符合的行程。

  - **終止所有名為 "sleep" 的行程**:
    ```bash
    tux@suse16:~> killall sleep
    ```

- **`pkill`**: 根據名稱或其他屬性來終止行程，是 `pgrep` 和 `kill` 的結合。

  - **終止所有屬於 "tux" 使用者的行程**:
    ```bash
    tux@suse16:~> pkill -u tux
    ```

- **`nice` / `renice`**: 調整行程的執行優先級。Nice 值的範圍從 -20 (最高優先級) 到 19 (最低優先級)。

  - **以較低的優先級啟動一個新程式**:
    ```bash
    tux@suse16:~> nice -n 10 my_program
    ```
  - **調整一個已在執行中行程的優先級**:
    ```bash
    tux@suse16:~> renice 15 -p 1234
    ```

- **`jobs`, `fg`, `bg`**: 管理在終端機背景執行的工作。
  - **`jobs`**: 列出目前在背景執行的工作。
    ```bash
    tux@suse16:~> jobs
    ```
  - **`fg %1`**: 將編號為 1 的背景工作移至前景執行。
    ```bash
    tux@suse16:~> fg %1
    ```
  - **`bg %1`**: 讓一個暫停的背景工作繼續在背景執行。
    ```bash
    tux@suse16:~> bg %1
    ```

### 練習

1.  **列出所有行程**：請使用 `ps` 指令，以 `aux` 和 `-ef` 兩種風格分別列出目前系統上所有的行程。
2.  **尋找特定行程**：系統可能正在執行一個名為 `systemd` 的行程，請用 `pgrep` 找出它的 PID。
3.  **背景工作**：
    -   執行 `sleep 300 &` 將一個睡眠 300 秒的指令放到背景。
    -   使用 `jobs` 查看背景工作的狀態。
    -   使用 `fg` 將該工作拉回前景。
    -   按下 `Ctrl+Z` 暫停它。
    -   使用 `bg` 讓它在背景繼續執行。
    -   最後，使用 `kill` 或 `pkill` 終止這個 `sleep` 行程。

---

## 3-2. 硬體資訊 (Hardware Information)

了解系統的硬體配置是進行系統管理和效能調校的基礎。

- **CPU**:

  - **`lscpu`**: 顯示 CPU 的架構資訊，如核心數、時脈、快取大小等。
    ```bash
    tux@suse16:~> lscpi
    ```
  - **`/proc/cpuinfo`**: 一個虛擬檔案，提供非常詳細的 CPU 資訊。
    ```bash
    tux@suse16:~> cat /proc/cpuinfo
    ```

- **RAM**:

  - **`free`**: 顯示系統的實體記憶體與交換空間 (swap) 的使用情況。
    - **以對人類友善的單位 (如 GB, MB) 顯示**:
      ```bash
      tux@suse16:~> free -h
      ```
  - **`/proc/meminfo`**: 提供比 `free` 更詳細的記憶體資訊。
    ```bash
    tux@suse16:~> cat /proc/meminfo
    ```

- **Disk**:

  - **`lsblk`**: 列出系統上所有的區塊設備 (block device)，如硬碟、SSD 及其分割區。

  ```bash
  tux@suse16:~> lsblk
  ```

  - **`fdisk -l`**: 列出所有磁碟的分割區表資訊。

  ```bash
  tux@suse16:~> sudo fdisk -l /dev/vda
  ```

  - **`parted -s`**: 列出所有磁碟的分割區表資訊。

  ```bash
  tux@suse16:~> sudo parted -s /dev/vda print
  ```

  - **`df`**: 顯示檔案系統的磁碟空間使用情況。
    - **以對人類友善的單位顯示**:
      ```bash
      tux@suse16:~> df -h
      ```

- **PCI / USB**:

  - **`lspci`**: 列出所有連接在 PCI 匯流排上的設備，如顯示卡、網卡。
    ```bash
    tux@suse16:~> lspci
    ```
  - **`lsusb`**: 列出所有連接在 USB 匯流排上的設備。
    ```bash
    tux@suse16:~> lsusb
    ```

- **NIC (Network Interface Card)**:

  - **`ip addr`** 或 **`ifconfig`**: 顯示網路介面的設定，如 IP 位址、MAC 位址等 (`ifconfig` 已被 `ip` 指令取代)。

    ```bash
    tux@suse16:~> ip addr

    tux@suse16:~> ifconfig
    ```

  - **`ethtool eth0`**: 查詢或設定指定網卡 (如 `eth0`) 的驅動程式與硬體參數。
    ```bash
    tux@suse16:~> ethtool eth0
    ```

- **主機板與其他**:

  - **`dmidecode`**: 解碼主機板的 DMI (Desktop Management Interface) 資訊，可得知 BIOS 版本、主機板型號、記憶體插槽資訊等。

  ```bash
  tux@suse16:~> dmidecode                # 顯示 DMI (或 SMBIOS) 表格的內容
  tux@suse16:~> dmidecode -t baseboard   # 顯示主機板資訊
  tux@suse16:~> dmidecode -t bios        # 顯示 BIOS 資訊
  tux@suse16:~> dmidecode -t chassis     # 顯示機箱資訊
  ```

  - **`hwinfo`** / **`lshw`**: 提供整個系統非常詳盡的硬體資訊報告。
    ```bash
    tux@suse16:~> hwinfo
    tux@suse16:~> lshw
    ```

- **NUMA (Non-Uniform Memory Access)**:
  - **`hwloc-ls`** 或 **`lstopo-no-graphics`**: 在多處理器系統中，顯示 CPU、記憶體之間的拓撲關係。
    ```bash
    tux@suse16:~> hwloc-ls
    tux@suse16:~> lstopo-no-graphics
    ```

### 練習

1.  **CPU 資訊**：使用 `lscpu` 查看你的 CPU 有幾顆核心。
2.  **記憶體使用**：使用 `free -h` 查看目前系統的記憶體與交換空間使用情況。
3.  **磁碟空間**：使用 `df -h` 檢查根目錄 (`/`) 的磁碟使用率。
4.  **網路介面**：使用 `ip addr` 找出電腦主要網路介面名稱以及它的 IP 位址。

---

## 3-3. 系統監控 (System Monitoring)

即時監控系統狀態，有助於快速發現問題。

- **`top`**: 動態顯示系統的整體效能資訊與行程列表，預設按 CPU 使用率排序。
- **`htop`**: `top` 的強化版，提供彩色的介面、滑鼠操作以及更方便的操作方式。
- **`atop`**: 更進階的系統與行程監控工具，可以記錄歷史資料以供事後分析。
- **`nmon`**: 一個整合性的效能監控工具，可以在單一畫面顯示 CPU, Memory, Disk I/O, Network 等多種資訊。
- **`iotop`**: 專門用來監控磁碟 I/O 的工具，可以找出是哪個行程在大量讀寫磁碟。
- **`nethogs`**: 專門用來監控網路流量的工具，可以找出是哪個行程佔用了大量頻寬。

### 練習

1.  **即時監控**：打開 `top` 或 `htop`，觀察目前系統上最耗費 CPU 資源的行程是哪一個。
2.  **磁碟 I/O**：如果你懷疑有程式正在大量讀寫硬碟，可以如何使用 `iotop` 來找出它？ (提示: 需要 `root` 權限)

---

## 3-4. 效能統計 (System Statistics)

相較於即時監控，統計工具用於收集長期的效能數據，進行趨勢分析。

- **`sar` (System Activity Reporter)**: 功能強大的系統活動報告工具，可以收集 CPU, Memory, I/O, Network 等多方面的歷史數據。
  - **每 1 秒收集一次 CPU 使用率，共收集 5 次**:
    ```bash
    tux@suse16:~> sar -u 1 5
    ```
- **`iostat`**: 報告 CPU 統計與裝置的 I/O 統計。
- **`mpstat`**: 報告每個 CPU 核心的詳細統計資訊。
- **`pidstat`**: 報告特定行程或所有行程的資源使用統計 (CPU, Memory, I/O)。
- **`vmstat`**: 報告虛擬記憶體的統計資訊，同時也會顯示 CPU 與 I/O 的簡要資訊。
- **`vnstat`**: 一個基於主控台的網路流量監控器，會記錄網卡的總流量歷史。

### 練習

1.  **CPU 歷史數據**：使用 `sar` 指令，每 2 秒收集一次 CPU 活動，總共收集 3 次。
2.  **記憶體統計**：執行 `vmstat 5`，觀察系統在一段時間內的記憶體、分頁 (paging) 與 CPU 活動變化。

---

## 3-5. 網路問題排查工具 (Network Troubleshooting)

- **基本連線**:

  - **`ping`**: 傳送 ICMP 封包來測試與目標主機的網路是否連通。
  - **`traceroute` / `tracepath`**: 追蹤封包從本機到目標主機所經過的路由路徑。

- **網路介面**:

  - **`ss`** 或 **`netstat`**: 顯示網路連線狀態、路由表、介面統計等 (`netstat` 已被 `ss` 取代)。
    - **顯示所有正在監聽的 TCP/UDP 連接埠**:
      ```bash
      tux@suse16:~> ss -tuln
      ```

- **DNS 解析**:

  - **`dig` / `nslookup` / `host`**: 用於查詢 DNS (Domain Name System)，將網域名稱解析為 IP 位址。
    - **查詢 `www.google.com` 的 IP 位址**:
      ```bash
      tux@suse16:~> dig www.google.com
      ```

- **防火牆與路由**:
  - **`ip route`** 或 **`route`**: 顯示或設定核心的 IP 路由表。
  - **`tcpdump`**: 一個強大的網路封包分析工具，可以擷取並顯示通過網卡的封包內容，用於深度問題分析。

### 練習

1.  **網路連線**：使用 `ping` 檢查是否可以連上 `8.8.8.8` (Google 的 DNS 伺服器)。
2.  **監聽的服務**：使用 `ss -tuln` 查看系統上有哪些網路服務正在監聽連線請求。
3.  **DNS 查詢**：使用 `dig` 或 `host` 指令，查詢 `github.com` 的 IP 位址。

---

## 3-6. 套件

[repo-oss](http://cdn.opensuse.org/distribution/leap/16.0/repo/oss/x86_64)

| package              | command                             | repositroy |
| -------------------- | ----------------------------------- | ---------- |
| atop                 | atop                                | repo-oss   |
| bash                 | bg, fg, jobs                        | repo-oss   |
| bind-utils           | dig, host, nslookup                 | repo-oss   |
| coreutils            | nice                                | repo-oss   |
| dmidecode            | dmidecode                           | repo-oss   |
| ethtool              | ethtool                             | repo-oss   |
| htop                 | htop                                | repo-oss   |
| hwinfo               | hwinfo                              | repo-oss   |
| hwloc                | hwloc, lstopo-no-graphics           | repo-oss   |
| iotop                | iotop                               | repo-oss   |
| iproute2             | ip, ss, tracepath                   | repo-oss   |
| iputils              | iputils, ping                       | repo-oss   |
| lshw                 | lshw                                | repo-oss   |
| nmon                 | nmon                                | repo-oss   |
| netcat-openbsd       | nc                                  | repo-oss   |
| nethogs              | nethogs                             | repo-oss   |
| net-tools-deprecated | ifconfg, netstat, route             | repo-oss   |
| pciutils             | lspci                               | repo-oss   |
| procps               | free, top, pgrep, pkill, ps, vmstat | repo-oss   |
| psmisc               | pstree, killall                     | repo-oss   |
| sysstat              | iostat, mpstat, pidstat, sar        | repo-oss   |
| tcpdump              | tcpdump                             | repo-oss   |
| traceroute           | traceroute                          | repo-oss   |
| usbutils             | lsusb                               | repo-oss   |
| vnstat               | vnstat                              | repo-oss   |
| util-linux           | fdisk, kill, lscpu, renice          | repo-oss   |
| util-linux-systemd   | lsblk                               | repo-oss   |

### 練習

1.  **查詢套件**：`lscpu` 這個指令是由哪個套件提供的？
2.  **指令是否存在**：系統上是否安裝了 `nmon`？如果沒有，它屬於哪個套件？

---

## 3-7. 總結

本章節介紹了 Linux 系統中用於管理和監控的關鍵指令。從基礎的行程管理 (`ps`, `kill`)、硬體資訊查詢 (`lscpu`, `free`)，到進階的系統效能監控 (`top`, `sar`) 與網路問題排查 (`ping`, `ss`, `dig`)，這些都是系統管理員日常工作中不可或缺的工具。透過熟練地運用這些指令，我們能有效地掌握系統的即時狀態、診斷潛在問題並進行效能調校。本章提供的練習旨在幫助初學者將理論知識應用於實際操作，從而加深理解。

### 章節練習

1.  **綜合情境**：
    *   系統感覺很慢。
    *   請使用 `top` 或 `htop` 找出最耗資源的行程 PID。
    *   使用 `pidstat` 針對該 PID 進行更詳細的資源分析。
    *   如果它是一個失控的程式，請使用 `kill` 將它正常終止。如果無法終止，再使用 `kill -9`。
2.  **系統報告**：
    *   請產生一份簡單的系統報告，包含以下資訊：
        *   CPU 型號與核心數 (`lscpu`)。
        *   總記憶體大小 (`free -h`)。
        *   根目錄的磁碟使用率 (`df -h`)。
        *   主機的 IP 位址 (`ip addr`)。
