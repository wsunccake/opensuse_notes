# ch4. Linux 服務管理

本章節將深入探討在 openSUSE 16 環境中常見的網路服務。從服務的基本概念開始，介紹主從式架構 (Client-Server Architecture)，並逐一解析各種重要服務的設定與管理，包括 SSH、NTP、NFS、Web Server 等。透過本章的學習，將能夠獨立建構和管理一個功能完善的 Linux 伺服器。

## 4-0. 主從式架構 (Client-Server Architecture)

在網路世界中，大多數的服務都基於主從式架構。這個模型將電腦的角色分為兩類：

1.  **伺服器 (Server)**: 提供服務、儲存資料、管理資源的電腦。它被動地等待來自客戶端的請求，並在接收到請求後進行處理，最後回傳結果。
2.  **客戶端 (Client)**: 請求服務、存取伺服器上資源的電腦或應用程式。它主動地向伺服器發出請求。

這個架構的運作模式如下圖所示：

```
+----------+        +----------+        +----------+
| Client A |        | Client B |        | Client C |
| (請求者) |        | (請求者) |        | (請求者) |
+----------+        +----------+        +----------+
     |                   |                   |
     |  請求 (Request)   |  請求 (Request)   |  請求 (Request)
     v                   v                   v
+-------------------------------------------------+
|               網路 (Network) / 網際網路          |
+-------------------------------------------------+
     ^                   ^                   ^
     |  回應 (Response)  |  回應 (Response)  |  回應 (Response)
     |                   |                   |
+-------------------------------------------------+
|                  Server (伺服器)                |
|           (提供服務、管理資源與資料)             |
+-------------------------------------------------+
```

- **伺服器 IP (範例)**: `192.168.122.57`
- **客戶端 IP (範例)**: `192.168.122.58`

接下來，將開始介紹各種常見的 Linux 服務。

### 練習

1.  **思考題**：在瀏覽器中輸入 `www.google.com` 並按下 Enter 時，扮演的是「客戶端」還是「伺服器」的角色？Google 的主機扮演的又是什麼角色？

---

## 4-1. SSH (Secure Shell)

SSH 是一種加密的網路傳輸協定，用於在不安全的網路上安全地執行遠端命令和管理伺服器。

### 演進歷史

1.  **rsh/rlogin (Remote Shell/Remote Login)**: 早期用於遠端管理的工具，但所有傳輸的資料，包括使用者名稱和密碼，都是未經加密的明文，非常不安全。
2.  **Telnet**: Telnet 同樣以明文傳輸資料，雖然比 rsh/rlogin 功能稍多，但在安全性上存在同樣的風險，容易被竊聽。
3.  **SSH (Secure Shell)**: 為了克服 Telnet 和 rsh 的安全缺陷而誕生。SSH 使用公鑰加密技術對所有傳輸的資料進行加密，有效防止了中間人攻擊和竊聽，成為現今遠端管理的標準。

### 4-1-1. SSH Server

在 openSUSE 上安裝和設定 SSH 伺服器 (sshd)。

- **安裝 OpenSSH Server 套件**:

  ```bash
  server:~> sudo zypper in openssh-server
  ```

  使用 `zypper` 套件管理器來安裝 `openssh-server`，這是提供 SSH 服務的核心軟體。

- **複製預設設定檔**:

  ```bash
  server:~> sudo cp /usr/etc/ssh/sshd_config /etc/ssh/sshd_config
  server:~> sudo cp /usr/etc/ssh/ssh_config /etc/ssh/ssh_config
  ```

  為了避免直接修改系統預設的設定檔，我們將它們複製到 `/etc/ssh/` 目錄下。`/etc/` 目錄是系統管理員放置本地設定檔的地方。`sshd_config` 是伺服器端的設定檔，`ssh_config` 是客戶端的設定檔。

- **啟動並設定開機自啟 SSH 服務**:

  ```bash
  server:~> sudo systemctl enable sshd.service
  server:~> sudo systemctl start sshd.service
  server:~> sudo systemctl status sshd.service
  ```

  - `systemctl enable sshd.service`: 設定 `sshd` 服務在開機時自動啟動。
  - `systemctl start sshd.service`: 立即啟動 `sshd` 服務。
  - `systemctl status sshd.service`: 檢查 `sshd` 服務的目前狀態，確認是否正常運行。

- **設定防火牆**:

  ```bash
  server:~> sudo firewall-cmd --add-service=ssh --permanent
  server:~> sudo firewall-cmd --reload
  ```

  - `--add-service=ssh`: 允許 `ssh` 服務通過防火牆。SSH 預設使用 22 port。
  - `--permanent`: 將此規則永久保存，重開機後依然有效。
  - `--reload`: 重新載入防火牆規則，使新規則生效。

- **測試設定檔語法**:
  ```bash
  server:~> sshd -T
  ```
  此指令會檢查 `/etc/ssh/sshd_config` 的設定是否正確，並輸出最終生效的設定值，有助於除錯。

#### `/etc/ssh/sshd_config` 重要參數說明

這個檔案掌管 SSH 伺服器的所有行為。

- `Port 22`: 指定 SSH 服務監聽的 port，預設為 22。為了安全，可以改成一個不常用的 port。
- `PermitRootLogin prohibit-password`: 是否允許 `root` 使用者登入。建議設定為 `prohibit-password` 或 `no`，以增強安全性。`prohibit-password` 允許 root 使用金鑰登入，但禁止使用密碼登入。
- `PasswordAuthentication yes`: 是否允許使用密碼進行身份驗證。若要強制使用金鑰登入，可以設為 `no`。
- `PubkeyAuthentication yes`: 是否允許使用公鑰進行身份驗證。這是 SSH 的核心安全功能，應保持啟用。
- `AllowUsers user1 user2`: 設定只允許 `user1` 和 `user2` 登入，其他使用者將被拒絕。
- `AllowGroups group1`: 設定只允許 `group1` 群組的使用者登入。

### 4-1-2. SSH Client

- **從客戶端連線到伺服器**:

  ```bash
  client:~> ssh tux@<server_ip>
  ```

  將 `<server_ip>` 替換為您的 SSH 伺服器 IP 位址。第一次連線時，系統會詢問是否要信任該主機的公鑰。

- **客戶端設定檔 `~/.ssh/config`**:
  為了簡化連線操作，在客戶端建立 `~/.ssh/config` 檔案，範例如下：

  ```
  Host suse16-server
      HostName 192.168.122.57
      User tux
      Port 22
  ```

  設定完成後，可使用以下簡短的指令進行連線：

  ```bash
  client:~> ssh suse16-server
  ```

### 練習

1.  **遠端連線**：請嘗試使用 `ssh` 指令，以 `tux` 使用者的身份連線到您的伺服器。
2.  **簡化連線**：在客戶端上設定 `~/.ssh/config` 檔案，為伺服器建立一個別名 (例如 `my-server`)，並嘗試使用這個別名進行連線。
3.  **安全設定**：(進階) 嘗試修改伺服器上的 `/etc/ssh/sshd_config`，將 `PasswordAuthentication` 改為 `no`，並設定使用 SSH 金鑰登入。這將大幅提升伺服器安全性。

---

## 4-2. NTP (Network Time Protocol)

NTP 是一種用於同步網路中各個電腦時間的協定。準確的時間在分散式系統、日誌記錄和安全中至關重要。

### 演進歷史

1.  **NTP (Network Time Protocol)**: 傳統的時間同步協定，精確度高，但設定較為複雜。
2.  **SNTP (Simple Network Time Protocol)**: NTP 的簡化版，適用於不需要極高精確度的客戶端。
3.  **Chrony**: 一個現代的 NTP 實作，在間歇性網路連線或網路壅塞的環境下表現比傳統 NTP 更好。Chrony 啟動速度快，能更快地同步時間，因此成為許多現代 Linux 發行版的預設選擇。

### 4-2-1. Chrony

在 openSUSE 16 中，`chronyd` 是預設的時間同步服務。

- **安裝 Chrony**:

  ```bash
  tux@suse16:~> sudo zypper in chrony
  ```

- **設定 Chrony**:
  編輯 `/etc/chrony.conf` 檔案，設定時間伺服器。可使用 `pool` 指令來指定一個伺服器池，以獲得更好的可靠性。

  ```bash
  tux@suse16:~> sudo vi /etc/chrony.conf
  ```

  在檔案中加入或修改：

  ```
  pool 2.pool.ntp.org iburst
  ```

- **啟動並設定開機自啟 Chrony 服務**:

  ```bash
  tux@suse16:~> sudo systemctl enable chronyd.service
  tux@suse16:~> sudo systemctl start chronyd.service
  tux@suse16:~> sudo systemctl status chronyd.service
  ```

- **設定防火牆**:

  ```bash
  tux@suse16:~> sudo firewall-cmd --add-service=ntp --permanent
  tux@suse16:~> sudo firewall-cmd --reload
  ```

  NTP 服務使用 UDP 123 port。

- **檢查同步狀態**:
  ```bash
  tux@suse16:~> chronyc sources
  tux@suse16:~> chronyc tracking
  ```
  - `chronyc sources`: 顯示目前正在使用的時間伺服器及其狀態。
  - `chronyc tracking`: 顯示系統時鐘與時間伺服器的同步狀況。

### 練習

1.  **檢查時間同步**：執行 `chronyc tracking`，查看 `Leap status` 是否為 `Normal`。
2.  **列出時間來源**：執行 `chronyc sources`，查看系統正在與哪些時間伺服器進行同步，並注意 `*` 號，它代表目前主要同步的來源。

---

## 4-3. RPC (Remote Procedure Call)

RPC 是一種允許程式呼叫另一台電腦上程序的協定，而不需要了解底層網路細節。許多傳統的 Linux 服務，如 NFS 和 NIS，都依賴於 RPC。

### 演進歷史

RPC 的概念自 1970 年代就已存在，由 Sun Microsystems (昇陽) 將其發揚光大，並廣泛應用於其網路服務中。`rpcbind` 服務（也稱為 `portmapper`）是 RPC 的核心，負責將 RPC 服務的程式編號對應到實際的 TCP/UDP port。

- **啟動並設定開機自啟 RPC 服務**:

  ```bash
  tux@suse16:~> sudo systemctl enable rpcbind.socket
  tux@suse16:~> sudo systemctl start rpcbind.socket
  tux@suse16:~> sudo systemctl status rpcbind.socket
  ```

  在現代 `systemd` 系統中，`rpcbind` 通常由 `socket` 啟用，當有服務請求時，`systemd` 會自動啟動 `rpcbind`。

- **設定防火牆**:
  ```bash
  tux@suse16:~> sudo firewall-cmd --add-service=rpc-bind --permanent
  tux@suse16:~> sudo firewall-cmd --reload
  ```
  `rpc-bind` 服務使用 TCP/UDP 111 port。

### 練習

1.  **檢查服務狀態**：使用 `systemctl status rpcbind.socket` 指令，確認 `rpcbind` 服務是否正在 `active (listening)` 狀態。
2.  **查看 port**：(進階) 使用 `ss -tuln | grep 111` 指令，確認 `rpcbind` 正在監聽 111 port。

---

## 4-4. NIS (Network Information Service)

NIS (原名 Yellow Pages, YP) 是一種目錄服務，用於在網路中的多台電腦之間集中管理使用者帳號、群組和主機名稱等設定檔。

### 演進歷史

NIS 由 Sun Microsystems 開發，旨在簡化 Unix 網路中的系統管理。透過 NIS，管理員只需在 NIS 主伺服器上更新使用者資料，所有 NIS 客戶端就能自動獲取這些更新，無需在每台機器上手動同步。然而，NIS 的安全性較弱，資料傳輸為明文，逐漸被 LDAP 等更安全的目錄服務取代。

### 4-4-1. 設定 NIS Domain

在設定 NIS 伺服器或客戶端之前，必須先設定一個 NIS 域名。

- **設定 NIS 域名**:
  編輯 `/etc/sysconfig/network/config` 檔案，設定 `NETCONFIG_NIS_STATIC_DOMAIN`。

  ```bash
  tux@suse16:~> sudo vi /etc/sysconfig/network/config
  ```

  找到並修改：

  ```
  NETCONFIG_NIS_STATIC_DOMAIN="suse16"
  ```

  或者，使用 `nisdomainname` 指令臨時設定：

  ```bash
  tux@suse16:~> sudo nisdomainname suse16
  ```

- **啟動域名服務**:

  ```bash
  tux@suse16:~> sudo systemctl enable nis-domainname.service
  tux@suse16:~> sudo systemctl start nis-domainname.service
  ```

- **檢查域名**:
  ```bash
  tux@suse16:~> nisdomainname
  ```
  此指令應顯示設定的域名 `suse16`。

### 4-4-2. NIS Server

**注意**: 設定 NIS Server 前，請確保 `rpcbind` 服務已啟動，且 NIS Domain 已設定。

- **安裝 NIS Server 套件**:

  ```bash
  server:~> sudo zypper ar https://download.opensuse.org/repositories/home:syntron:NIS/16.0/home:syntron:NIS.repo
  server:~> sudo zypper ref
  server:~> sudo zypper in ypserv
  ```

- **設定檔**:

  - `/etc/ypserv.conf`: 設定 NIS 伺服器的行為。
  - `/var/yp/securenets`: 設定允許存取此 NIS 伺服器的網段。
    ```bash
    server:~> sudo vi /var/yp/securenets
    ```
    範例內容：
    ```
    255.0.0.0       127.0.0.0
    255.255.255.0   192.168.122.0
    ```

- **固定 Port (可選)**:
  為了方便防火牆設定，可以固定 `ypserv` 的 port。

  ```bash
  server:~> sudo cp /usr/etc/default/ypserv /etc/default/ypserv
  server:~> sudo vi /etc/default/ypserv
  ```

  修改 `YPSERV_ARGS`：

  ```
  YPSERV_ARGS="--port 839"
  ```

- **啟動服務與防火牆**:

  ```bash
  server:~> sudo systemctl enable ypserv.service
  server:~> sudo systemctl start ypserv.service
  server:~> sudo firewall-cmd --add-port=839/tcp --permanent
  server:~> sudo firewall-cmd --add-port=839/udp --permanent
  server:~> sudo firewall-cmd --reload
  ```

- **初始化資料庫**:
  ```bash
  server:~> sudo /usr/lib/yp/ypinit -m
  ```
  此指令會將 `/etc/passwd`, `/etc/group` 等檔案轉換為 NIS 資料庫。

### 4-4-3. NIS Client

**注意**: 設定 NIS Client 前，請確保 `rpcbind` 服務已啟動，且 NIS Domain 已設定。

- **安裝 NIS Client 套件**:

  ```bash
  client:~> sudo zypper in ypbind
  ```

- **設定檔**:

  - `/etc/yp.conf`: 指定 NIS 伺服器的位置。
    ```
    domain suse16 server 192.168.122.57
    ```
  - `/etc/nsswitch.conf`: 告訴系統去哪裡尋找名稱解析資訊 (如使用者帳號)。
    ```
    passwd: compat
    group:  compat
    shadow: compat
    ```
    `compat` 模式會先查找本地檔案 (`/etc/passwd`)，如果找不到，再透過 NIS 查找。

- **啟動服務**:

  ```bash
  client:~> sudo systemctl enable ypbind.service
  client:~> sudo systemctl start ypbind.service
  ```

- **測試**:
  ```bash
  client:~> getent passwd | grep user1
  ```
  如果能看到在 NIS 伺服器上建立的 `user1`，表示設定成功。

### 練習

1.  **確認 NIS 網域**：在 NIS 客戶端上，執行 `nisdomainname`，確認輸出是否為您設定的域名 (例如 `suse16`)。
2.  **查詢使用者資訊**：在 NIS 客戶端上，使用 `getent passwd` 或 `ypcat passwd` 指令，查看是否能列出從 NIS 伺服器上同步過來的使用者帳號。
3.  **切換使用者**：嘗試在 NIS 客戶端上使用 `su - <nis_user>` 切換到一個 NIS 使用者，測試是否能成功登入。

---

## 4-5. NFS (Network File System)

NFS 允許遠端伺服器上的目錄掛載到本地電腦上，像存取本地檔案一樣存取遠端檔案。

### 演進歷史

NFS 同樣由 Sun Microsystems 開發，是 Unix/Linux 環境中最常用的網路檔案系統。

- **NFSv2**: 早期版本，只支援 UDP，有 2GB 檔案大小限制。
- **NFSv3**: 引入 TCP 支援，提高了穩定性和效能，支援大檔案。
- **NFSv4**: 最新主要版本，整合了鎖定、掛載和安全機制，只需單一 port (2049)，更容易通過防火牆。它還引入了更強的安全性 (Kerberos) 和更好的效能。

### 4-5-1. NFS Server 設定

- **安裝 NFS Server 套件**:

  ```bash
  server:~> sudo zypper in nfs-kernel-server
  ```

- **建立分享目錄**:

  ```bash
  server:~> sudo mkdir -p /srv/nfs/shared_data
  server:~> sudo chmod 777 /srv/nfs/shared_data
  ```

- **設定分享**:
  編輯 `/etc/exports` 檔案，定義要分享的目錄和權限。

  ```bash
  server:~> sudo vi /etc/exports
  ```

  加入以下內容：

  ```
  /srv/nfs/shared_data 192.168.122.0/24(rw,sync,no_subtree_check)
  ```

  - `/srv/nfs/shared_data`: 要分享的目錄。
  - `192.168.122.0/24`: 允許存取的客戶端網段。
  - `rw`: 讀寫權限。
  - `sync`: 資料同步寫入，較安全但速度較慢。
  - `no_subtree_check`: 禁用子樹檢查，可提高效能。

- **啟動服務與防火牆**:
  ```bash
  server:~> sudo systemctl enable nfs-server.service
  server:~> sudo systemctl start nfs-server.service
  server:~> sudo firewall-cmd --add-service=nfs --permanent
  server:~> sudo firewall-cmd --reload
  ```

### 4-5-2. NFS Client

- **安裝 NFS Client 套件**:

  ```bash
  client:~> sudo zypper in nfs-client
  ```

- **建立掛載點**:

  ```bash
  client:~> sudo mkdir -p /mnt/nfs_share
  ```

- **手動掛載**:

  ```bash
  client:~> sudo mount 192.168.122.57:/srv/nfs/shared_data /mnt/nfs_share
  ```

  設定伺服器 IP 和分享路徑。

- **測試**:
  ```bash
  client:~> df -h
  client:~> touch /mnt/nfs_share/test_file_from_client
  ```
  使用 `df -h` 檢查是否掛載成功，並嘗試在掛載點建立檔案。

### 練習

1.  **掛載 NFS 分享**：在 NFS 客戶端上，手動掛載伺服器分享出來的 `/srv/nfs/shared_data` 目錄到 `/mnt/nfs_share`。
2.  **測試存取**：掛載成功後，在 `/mnt/nfs_share` 目錄下建立一個名為 `hello.txt` 的檔案。
3.  **檢查同步**：回到 NFS 伺服器，檢查 `/srv/nfs/shared_data` 目錄下是否出現了 `hello.txt` 這個檔案。

---

## 4-6. Web Server

Web 伺服器是用於儲存、處理和傳遞網頁給客戶端的軟體。

### 演進歷史

- **Apache**: 自 1995 年以來最受歡迎的 Web 伺服器之一。它功能強大、模組豐富、穩定可靠，但相對消耗較多記憶體。
- **Nginx**: 一個高效能、輕量級的 Web 伺服器和反向代理伺服器。它以其出色的併發處理能力 (C10k 問題) 和低資源消耗而聞名，特別適合處理靜態檔案和高流量網站。

根據需求選擇其中一個來安裝。

### 4-6-1. Apache2

- **安裝 Apache2**:

  ```bash
  server:~> sudo zypper in apache2
  ```

- **啟動服務與防火牆**:
  ```bash
  server:~> sudo systemctl enable apache2.service
  server:~> sudo systemctl start apache2.service
  server:~> sudo firewall-cmd --add-service=http --permanent
  server:~> sudo firewall-cmd --reload
  ```
  預設網站根目錄位於 `/srv/www/htdocs/`。

### 4-6-2. Nginx

- **安裝 Nginx**:

  ```bash
  server:~> sudo zypper in nginx
  ```

- **啟動服務與防火牆**:
  ```bash
  server:~> sudo systemctl enable nginx.service
  server:~> sudo systemctl start nginx.service
  server:~> sudo firewall-cmd --add-service=http --permanent
  server:~> sudo firewall-cmd --reload
  ```
  預設網站根目錄通常也位於 `/srv/www/htdocs/`。

### 練習

1.  **建立測試網頁**：在 Web 伺服器上，於 `/srv/www/htdocs/` 目錄下建立一個名為 `index.html` 的檔案，內容可以寫 `<h1>Hello, openSUSE!</h1>`。
2.  **從遠端存取**：在客戶端電腦上，打開瀏覽器，輸入 `http://<server_ip>`，看看是否能看到您剛剛建立的網頁。
3.  **使用 `curl`**：在客戶端電腦的命令列中，執行 `curl http://<server_ip>`，看看是否能獲取到 `index.html` 的原始碼。

---

## 4-7. DNS (Domain Name System)

DNS 是網際網路的電話簿，它將人類可讀的網域名稱 (例如 `www.google.com`) 轉換為機器可讀的 IP 位址 (例如 `172.217.160.68`)。

### 演進歷史

在 DNS 出現之前，網路上有一份名為 `HOSTS.TXT` 的檔案，集中管理所有主機名稱和 IP 的對應。隨著網路主機數量的爆炸性增長，這種方式變得難以維護。因此，分散式、階層式的 DNS 系統應運而生。BIND (Berkeley Internet Name Domain) 是最早且最廣泛使用的 DNS 軟體。

### 4-7-1. DNS Server - BIND 設定

- **安裝 BIND**:

  ```bash
  server:~> sudo zypper in bind
  ```

- **設定檔解說**:

  - `/etc/named.conf`: BIND 的主要設定檔，定義了全域選項和 `zone` (區域)。
  - `/var/lib/named/master/`: 通常用來存放正向和反向解析的 `zone` 檔案。

- **設定步驟**:

  1.  **編輯 `/etc/named.conf`**:

      ```bash
      server:~> sudo vi /etc/named.conf
      ```

      在 `options` 區塊中，`listen-on` 和 `allow-query` 是重要參數，前者決定監聽哪個網路介面，後者決定允許哪些客戶端查詢。
      在檔案末尾加入 `zone` 定義：

      ```conf
      // 正向解析 zone
      zone "example.com" in {
         type master;
         file "master/example.com.zone"; // zone 檔案路徑
      };

      // 反向解析 zone
      zone "122.168.192.in-addr.arpa" in {
              type master;
              file "master/122.168.192.zone"; // zone 檔案路徑
      };
      ```

  2.  **建立正向解析 Zone 檔案**:

      ```bash
      server:~> sudo vi /var/lib/named/master/example.com.zone
      ```

      ```conf
      $TTL 1D
      @       IN SOA  ns1.example.com. admin.example.com. (
                              2025101301      ; Serial
                              3H              ; Refresh
                              15M             ; Retry
                              1W              ; Expire
                              1D )            ; Minimum TTL
      ;
      @       IN NS   ns1.example.com.
      ns1     IN A    192.168.122.57
      node1   IN A    192.168.122.58
      node2   IN A    192.168.122.59
      ```

  3.  **建立反向解析 Zone 檔案**:
      ```bash
      server:~> sudo vi /var/lib/named/master/122.168.192.zone
      ```
      ```conf
      $TTL 1D
      @       IN SOA  ns1.example.com. admin.example.com. (
                              2025101301      ; Serial
                              3H              ; Refresh
                              15M             ; Retry
                              1W              ; Expire
                              1D )            ; Minimum TTL
      ;
      @       IN NS   ns1.example.com.
      57      IN PTR  ns1.example.com.
      58      IN PTR  node1.example.com.
      59      IN PTR  node2.example.com.
      ```

- **啟動服務與防火牆**:
  ```bash
  server:~> sudo systemctl enable named.service
  server:~> sudo systemctl start named.service
  server:~> sudo firewall-cmd --add-service=dns --permanent
  server:~> sudo firewall-cmd --reload
  ```

### 4-7-2. DNS Client

- **使用 `dig` 指令**:

  ```bash
  # 查詢 node1.example.com 的 A 紀錄，使用自己的 DNS 伺服器
  client:~> dig @192.168.122.57 node1.example.com

  # 測試反向解析
  client:~> dig @192.168.122.57 -x 192.168.122.58
  ```

- **使用 `nslookup` 指令**:
  ```bash
  client:~> nslookup node1.example.com 192.168.122.57
  client:~> nslookup 192.122.58 192.168.122.57
  ```

### 練習

1.  **正向解析**：使用 `dig` 指令，向自己架設的 DNS 伺服器 (`@192.168.122.57`) 查詢 `node1.example.com` 的 IP 位址。
2.  **反向解析**：使用 `dig -x` 指令，向您的 DNS 伺服器查詢 `192.168.122.58` 這個 IP 對應的主機名稱是什麼。
3.  **查詢 NS 紀錄**：使用 `dig example.com NS` 查詢 `example.com` 這個區域的名稱伺服器 (Name Server) 是誰。

---

## 4-8. DHCP (Dynamic Host Configuration Protocol)

DHCP 服務可以自動分配 IP 位址、子網路遮罩、預設閘道和 DNS 伺服器等網路設定給區域網路中的客戶端，極大地簡化了網路管理。

### 演進歷史

DHCP 的前身是 BOOTP (Bootstrap Protocol)。BOOTP 主要用於無磁碟工作站的啟動，為其提供 IP 位址和啟動映像檔位置。DHCP 擴充了 BOOTP 的功能，能夠動態地分配和管理 IP 位址池，並提供更多的網路設定選項。

### 4-8-1. DHCP Server - ISC DHCP

- **安裝 ISC DHCP Server**:

  ```bash
  server:~> sudo zypper in dhcp-server
  ```

- **設定檔**:

  - `/etc/sysconfig/dhcpd`: 指定 DHCP 服務監聽的網路介面。
    ```bash
    server:~> sudo vi /etc/sysconfig/dhcpd
    ```
    找到 `DHCPD_INTERFACE` 並設定為內網網卡，例如 `eth0`。
  - `/etc/dhcpd.conf`: 主要設定檔，定義 IP 位址池和相關選項。

    ```bash
    server:~> sudo vi /etc/dhcpd.conf
    ```

    ```conf
    option domain-name "example.com";
    option domain-name-servers 192.168.122.57; // 指定 DNS 伺服器
    default-lease-time 600;
    max-lease-time 7200;

    subnet 192.168.122.0 netmask 255.255.255.0 {
      range 192.168.122.100 192.168.122.200;
      option routers 192.168.122.1;
    }
    ```

- **啟動服務與防火牆**:
  ```bash
  server:~> sudo systemctl enable dhcpd.service
  server:~> sudo systemctl start dhcpd.service
  server:~> sudo firewall-cmd --add-service=dhcp --permanent
  server:~> sudo firewall-cmd --reload
  ```

### 練習

1.  **檢查租約**：在 DHCP 伺服器上，可以查看 `/var/lib/dhcp/db/dhcpd.leases` 檔案，了解哪些 IP 已經被分配給了哪些客戶端。
2.  **客戶端測試**：將一台客戶端電腦的網路設定改為自動取得 IP (DHCP)，然後檢查它是否成功從 DHCP 伺服器獲取了 `192.168.122.100` 到 `192.168.122.200` 範圍內的 IP。
3.  **思考題**：如果沒有 DHCP 伺服器，一個新的裝置要加入區域網路，需要手動設定哪些資訊才能上網？

---

## 4-9. FTP (File Transfer Protocol)

FTP 是一個歷史悠久的檔案傳輸協定，用於在客戶端和伺服器之間上傳和下載檔案。

### 演進歷史

FTP 是最早的網路協定之一，但其設計初衷並未考慮安全性，使用者名稱、密碼和資料都是明文傳輸。因此，在需要安全傳輸的場合，通常會使用 FTPS (FTP over SSL/TLS) 或 SFTP (SSH File Transfer Protocol，與 FTP 無關，是 SSH 的一部分)。vsftpd (Very Secure FTP Daemon) 是一個以安全為重點的輕量級 FTP 伺服器。

### 4-9-1. FTP Server - vsftpd 設定

- **安裝 vsftpd**:

  ```bash
  server:~> sudo zypper in vsftpd
  ```

- **設定檔 `/etc/vsftpd.conf`**:

  ```bash
  server:~> sudo vi /etc/vsftpd.conf
  ```

  重要參數：

  - `anonymous_enable=NO`: 禁止匿名登入。
  - `local_enable=YES`: 允許本地使用者登入。
  - `write_enable=YES`: 允許上傳檔案。
  - `chroot_local_user=YES`: 將使用者限制在其家目錄中，增加安全性。
  - `pasv_enable=YES`: 啟用被動模式，以利於防火牆穿透。
  - `pasv_min_port=30000` / `pasv_max_port=30100`: 設定被動模式使用的 port 範圍。

- **啟動服務與防火牆**:
  ```bash
  server:~> sudo systemctl enable vsftpd.service
  server:~> sudo systemctl start vsftpd.service
  server:~> sudo firewall-cmd --add-service=ftp --permanent
  server:~> sudo firewall-cmd --add-port=30000-30100/tcp --permanent
  server:~> sudo firewall-cmd --reload
  ```

### 4-9-2. FTP Client 使用

Linux 提供了多種命令列 FTP 客戶端，如 `ftp`, `lftp`, `tnftp`。

```bash
client:~> sudo zypper in lftp

client:~> lftp tux@192.168.122.57
```

### 練習

1.  **連線測試**：使用 `lftp` 或其他 FTP 客戶端軟體，嘗試以 `tux` 使用者的身份登入您的 FTP 伺服器。
2.  **上傳檔案**：登入後，使用 `put` 指令上傳一個本地檔案到伺服器上。
3.  **下載檔案**：使用 `get` 指令將剛剛上傳的檔案下載回來。
4.  **安全性思考**：為什麼在現今的網路環境中，SFTP 或 FTPS 會是比傳統 FTP 更好的選擇？

---

## 4-10. TFTP (Trivial File Transfer Protocol)

TFTP 是一個極度簡化的檔案傳輸協定，通常用於網路設備 (如路由器、交換器) 的韌體更新或無磁碟工作站的網路開機 (PXE)。

### 演進歷史

TFTP 被設計為一個簡單、小巧的協定，它使用 UDP 作為傳輸層，沒有身份驗證，也沒有目錄列表功能。由於其簡單性，非常適合嵌入式系統。`atftp` 和 `tftp` (舊版是 `tftp-hpa`) 是兩種常見的 TFTP 伺服器實作。

`atftp`, `tftp` 選一個即可, 而 `tftp` 同時包括 server 跟 client tool

### 4-10-1. TFTP Server - atftp

- **安裝 atftp**:

  ```bash
  server:~> sudo zypper in atftp
  ```

- **設定與啟動**:
  TFTP 服務通常由 `systemd` 的 `socket` 啟用。服務的根目錄預設在 `/srv/tftpboot`。

  ```bash
  server:~> sudo systemctl enable atftpd.socket
  server:~> sudo systemctl start atftpd.socket
  ```

- **設定防火牆**:

  ```bash
  server:~> sudo firewall-cmd --add-service=tftp --permanent
  server:~> sudo firewall-cmd --reload
  ```

- **測試**:
  在伺服器上放置一個測試檔案。
  ```bash
  server:~> echo "tftp test" | sudo tee /srv/tftpboot/test.txt
  ```

### 4-10-2. TFTP Server - tftp

- **安裝 tftp server**:

  ```bash
  server:~> sudo zypper in tftp
  ```

- **設定與啟動**:
  TFTP 服務通常由 `systemd` 的 `socket` 啟用。服務的根目錄預設在 `/srv/tftpboot`。

  ```bash
  server:~> sudo systemctl enable tftpd.socket
  server:~> sudo systemctl start tftpd.socket
  ```

- **設定防火牆**:

  ```bash
  server:~> sudo firewall-cmd --add-service=tftp --permanent
  server:~> sudo firewall-cmd --reload
  ```

- **測試**:
  在伺服器上放置一個測試檔案。
  ```bash
  server:~> echo "tftp test" | sudo tee /srv/tftpboot/test.txt
  ```

### 4-10-3. TFTP Client

- **安裝 tftp client**:

  ```bash
  client:~> sudo zypper in tftp
  ```

- **下載檔案**:
  ```bash
  client:~> tftp 192.168.122.57 -c get test.txt
  client:~> cat test.txt
  ```

### 練習

1.  **準備測試檔案**：在 TFTP 伺服器的 `/srv/tftpboot` 目錄下，建立一個名為 `config.txt` 的檔案。
2.  **下載測試**：在 TFTP 客戶端上，使用 `tftp` 指令嘗試從伺服器下載 `config.txt` 檔案。
3.  **思考題**：TFTP 協定因為其簡單性而被用在網路設備的韌體更新上。您能想到為什麼在這種情境下，「簡單」比「功能強大」更重要嗎？

## 4-11. 總結

本章節完整地介紹了多種在 openSUSE 16 上至關重要的網路服務。從確保遠端管理安全的 **SSH**，到維持時間同步的 **Chrony**，實現檔案共享的 **NFS**，提供網頁服務的 **Apache/Nginx**，再到負責名稱解析的 **DNS (BIND)**，自動化網路設定的 **DHCP**，以及用於檔案傳輸的 **FTP/TFTP**。每一個服務都在現代 IT 基礎架構中扮演著不可或缺的角色。透過詳細的步驟說明、設定檔解說以及對服務演進歷史的探討，應該掌握了安裝、設定和管理這些服務的基本能力。了解技術的演進有助於做出更合適的選擇。

### 章節練習

1.  **情境整合：建立一個小型辦公室網路**
    假設您需要為一個小型辦公室設定一台多功能 Linux 伺服器，請規劃您的設定步驟：

    - **遠端管理**：您會如何設定，才能讓自己可以從座位上安全地管理這台伺服器？
    - **檔案共享**：您需要建立一個共享目錄，讓所有員工可以存取。您會選擇哪個服務？如何設定？
    - **內部網站**：公司需要一個內部網站來發布公告。您會選擇哪個 Web 伺服器？如何在上面發布一個簡單的歡迎頁面？
    - **自動化 IP**：為了避免手動為每一台新電腦設定 IP，您會使用哪個服務來自動化這個過程？

2.  **除錯練習**：
    - 您的同事無法 SSH 到伺服器，您會從哪幾個方面開始檢查問題？(提示：網路連線、防火牆、SSH 服務狀態、設定檔)
    - NFS 客戶端掛載失敗，顯示 `Connection refused`，可能的原因是什麼？(提示：伺服器端的服務是否啟動？防火牆是否阻擋？)
